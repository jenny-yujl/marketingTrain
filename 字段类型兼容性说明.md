# 字段类型兼容性说明

## 🔄 字段类型替换方案

为了确保与更多MySQL版本兼容，我们对数据库结构进行了优化：

### 替换的字段类型

#### 1. JSON → TEXT
**原类型**: `JSON`
**新类型**: `TEXT`
**说明**: 使用TEXT字段存储JSON格式的字符串

```sql
-- 替换前 (MySQL 5.7.8+)
`placements` JSON NOT NULL DEFAULT (JSON_ARRAY())

-- 替换后 (MySQL 5.0+)
`placements` TEXT NOT NULL DEFAULT '[]'
```

**影响的字段**:
- `placements` - 投放位置数组
- `device_types` - 设备类型数组
- `interests` - 兴趣标签数组
- `behaviors` - 行为标签数组
- `weekly_schedule` - 周时间安排数组

#### 2. BOOLEAN → TINYINT(1)
**原类型**: `BOOLEAN`
**新类型**: `TINYINT(1)`
**说明**: 使用TINYINT(1)存储布尔值 (0=假, 1=真)

```sql
-- 替换前 (MySQL 5.0.3+)
`has_time_limited_discount` BOOLEAN DEFAULT FALSE

-- 替换后 (MySQL 5.0+)
`has_time_limited_discount` TINYINT(1) DEFAULT 0
```

**影响的字段**:
- `has_time_limited_discount` - 是否有限时折扣
- `has_full_reduction` - 是否有满减

## 📊 兼容性对比

### MySQL版本要求

| 字段类型 | 原要求版本 | 新要求版本 | 兼容性提升 |
|---------|------------|------------|------------|
| JSON | 5.7.8+ | - | 已移除 |
| BOOLEAN | 5.0.3+ | - | 已移除 |
| TEXT | 所有版本 | 5.0+ | ✅ 完全兼容 |
| TINYINT(1) | 所有版本 | 5.0+ | ✅ 完全兼容 |
| DECIMAL | 所有版本 | 5.0+ | ✅ 完全兼容 |
| TIMESTAMP | 所有版本 | 5.0+ | ✅ 完全兼容 |

### 支持的MySQL版本
- ✅ MySQL 5.0+ (所有现代版本)
- ✅ MySQL 5.1+ 
- ✅ MySQL 5.5+
- ✅ MySQL 5.6+
- ✅ MySQL 5.7+
- ✅ MySQL 8.0+
- ✅ MariaDB 5.5+
- ✅ MariaDB 10.x

## 💻 应用层处理

### JSON数据处理

#### 在应用代码中处理JSON字符串:

```javascript
// 存储数据
const placements = ['直播间', '信息流'];
const placementsString = JSON.stringify(placements);

// 插入数据库
INSERT INTO campaigns (placements) VALUES ('["直播间", "信息流"]');

// 读取数据
const result = await db.query('SELECT placements FROM campaigns WHERE id = ?', [1]);
const placements = JSON.parse(result[0].placements);
```

#### Drizzle ORM中的处理:

```typescript
// 在shared/schema.ts中
export const campaigns = mysqlTable("campaigns", {
  // TEXT字段会自动处理JSON字符串
  placements: text("placements").notNull().default('[]'),
  // 应用层需要手动解析: JSON.parse(row.placements)
});
```

### BOOLEAN数据处理

#### TINYINT(1)作为布尔值:

```javascript
// 存储数据
const hasDiscount = true;
const hasDiscountInt = hasDiscount ? 1 : 0;

// 插入数据库
INSERT INTO campaigns (has_time_limited_discount) VALUES (1);

// 读取数据
const result = await db.query('SELECT has_time_limited_discount FROM campaigns WHERE id = ?', [1]);
const hasDiscount = result[0].has_time_limited_discount === 1;
```

## 🔧 数据迁移

### 从JSON到TEXT
如果您已有使用JSON字段的数据：

```sql
-- 迁移JSON数据到TEXT
UPDATE campaigns SET placements = JSON_UNQUOTE(placements) WHERE placements IS NOT NULL;
```

### 从BOOLEAN到TINYINT
如果您已有使用BOOLEAN字段的数据：

```sql
-- 迁移BOOLEAN数据到TINYINT
UPDATE campaigns SET has_time_limited_discount = CAST(has_time_limited_discount AS UNSIGNED);
```

## ⚡ 性能考虑

### TEXT字段的JSON数据查询
```sql
-- 使用LIKE查询JSON字符串中的值
SELECT * FROM campaigns WHERE placements LIKE '%"直播间"%';

-- 使用正则表达式 (MySQL 5.7+)
SELECT * FROM campaigns WHERE placements REGEXP '"直播间"';
```

### TINYINT布尔值查询
```sql
-- 直接使用数值比较
SELECT * FROM campaigns WHERE has_time_limited_discount = 1;
SELECT * FROM campaigns WHERE has_time_limited_discount = 0;
```

## 📋 完整替换总结

现在数据库使用的字段类型：
- ✅ **TEXT**: 用于存储JSON格式字符串
- ✅ **TINYINT(1)**: 用于存储布尔值
- ✅ **INT**: 用于整数
- ✅ **DECIMAL(10,2)**: 用于金额
- ✅ **TIMESTAMP**: 用于时间
- ✅ **VARCHAR/TEXT**: 用于文本

这样的设计确保了与从MySQL 5.0开始的几乎所有版本兼容，为您的应用提供了最大的部署灵活性。